import React, { useEffect, useRef, useState } from "react";

/**
 * Fukuoka Trip â€“ Pro UI (React Preview)
 * - Tailwind only, no external libs
 * - Timeline with fixed rail, aligned time + dot
 * - Map chooser dialog (Google / Apple)
 * - Flight detail drawer (swipe-down-to-close) with stricter threshold (~4cm â‰’ 150px)
 * - Scroll lock while dialogs are open
 */

/* ===== Helpers: map links ===== */
const gSearchByName = (name) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`;
const aSearchByName = (name) => `https://maps.apple.com/?q=${encodeURIComponent(name)}`;
const gByLatLng = (lat, lng, label) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(label)}&query_place_id=&center=${lat},${lng}`;
const aByLatLng = (lat, lng, label) => `https://maps.apple.com/?ll=${lat},${lng}&q=${encodeURIComponent(label)}`;

const mapLink = (target, place) => {
  if (place.lat && place.lng) {
    return target === "google" ? gByLatLng(place.lat, place.lng, place.label ?? place.name) : aByLatLng(place.lat, place.lng, place.label ?? place.name);
  }
  return target === "google" ? gSearchByName(place.name) : aSearchByName(place.name);
};

/* ===== Data ===== */
const day2_3LunchCandidates = [
  { name: "å…ƒç¥– åšå¤šã‚ã‚“ãŸã„é‡" },
  { name: "åšå¤šã‚·ãƒ¼ãƒ•ãƒ¼ãƒ‰ ã†ãŠç”°" },
  { name: "é­šãƒˆè‚´ ã„ã¨ãŠã‹ã—ï¼ˆæ˜¥å‰ï¼‰" },
  { name: "ã²ã—ã‚€ã‚‰ï¼ˆæ˜¥å‰ï¼‰" },
  { name: "å¤§åœ°ã®ã†ã©ã‚“ åšå¤šé§…ã¡ã‹ã¦ã‚“ï¼ˆæœæ—¥ãƒ“ãƒ«B2ï¼‰" },
];
const airportLunchCandidates = [
  { name: "ç«¹ä¹ƒå±‹ ç¦å²¡ç©ºæ¸¯åº—" },
  { name: "ãƒ©ãƒ¼ãƒ¡ãƒ³æ»‘èµ°è·¯ï¼ˆãƒ•ãƒ¼ãƒ‰ãƒ›ãƒ¼ãƒ«ï¼‰" },
  { name: "å› å¹¡ã†ã©ã‚“ï¼ˆç¦å²¡ç©ºæ¸¯ï¼‰" },
  { name: "ã†ã¾ã‚„ ç¦å²¡ç©ºæ¸¯åº—" },
  { name: "B.B.Quisineï¼ˆå›½å†…ç·š3Fï¼‰" },
];

// Hotel â€“ lock to coordinates from user's link for stability
const HOTEL_PLACE = { name: "HOTEL ç²‹ - sui - HARUYOSHI", lat: 33.58752, lng: 130.40260, label: "HOTEL ç²‹ - sui - HARUYOSHI" };

const timeline = [
  {
    day: "Day 1 (9/19 é‡‘)",
    events: [
      { time: "12:10", title: "ğŸ›« åå¤å±‹ç™ºï¼ˆé£›è¡Œæ©Ÿï¼‰", detail: "12:10 â†’ 13:35", kind: "flight-out" },
      { time: "12:15", title: "ğŸ›« æ±äº¬ç™ºï¼ˆé£›è¡Œæ©Ÿï¼‰", detail: "12:15 â†’ 14:10", kind: "flight-out" },
      { time: "15:00", title: "ğŸ´ ãŠæ˜¼", detail: "ç©ºæ¸¯å†…ã®å€™è£œï¼ˆ10äººä»¥ä¸ŠOKï¼‰", candidates: airportLunchCandidates },
      { time: "16:00", title: "ğŸ¨ ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³", detail: "HOTEL ç²‹ - sui - HARUYOSHIï¼ˆæ—§Grand Base Fukuokaï¼‰", place: HOTEL_PLACE },
      { time: "16:30", title: "ğŸš´ è‡ªè»¢è»Šè¦³å…‰", detail: "å¤§æ¿ å…¬åœ’ / ç¦å²¡åŸè·¡ / åšå¤šãƒãƒ¼ãƒˆã‚¿ãƒ¯ãƒ¼ / æ«›ç”°ç¥ç¤¾ / æ‰¿å¤©å¯ºé€šã‚Š ãªã©",
        candidates: [
          { name: "å¤§æ¿ å…¬åœ’" },
          { name: "ç¦å²¡åŸè·¡ï¼ˆèˆé¶´å…¬åœ’ï¼‰" },
          { name: "åšå¤šãƒãƒ¼ãƒˆã‚¿ãƒ¯ãƒ¼" },
          { name: "æ«›ç”°ç¥ç¤¾" },
          { name: "æ‰¿å¤©å¯ºé€šã‚Š" },
        ] },
      { time: "20:30", title: "ğŸ² å¤œã”é£¯", detail: "å…ƒç¥– ã‚‚ã¤é‹ æ¥½å¤©åœ° å¤©ç¥æœ¬åº—ï¼ˆã‚¢ã‚¯ãƒ­ã‚¹ç¦å²¡ B2Fï¼‰", place: { name: "å…ƒç¥– ã‚‚ã¤é‹ æ¥½å¤©åœ° å¤©ç¥æœ¬åº—" } },
      { time: "22:00", title: "ğŸ•’ è‡ªç”±æ™‚é–“" },
    ],
  },
  {
    day: "Day 2 (9/20 åœŸ)",
    events: [
      { time: "12:00", title: "ğŸ´ ãŠæ˜¼ï¼ˆå€™è£œï¼‰", detail: "å€™è£œã‹ã‚‰é¸æŠ", candidates: day2_3LunchCandidates },
      { time: "14:00", title: "ğŸ¯ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£", detail: "EXBAR TOKYO plus åšå¤šï¼ˆã‚­ãƒ£ãƒŠãƒ«ã‚·ãƒ†ã‚£åšå¤š 5Fï¼‰", place: { name: "EXBAR TOKYO plus åšå¤š" } },
      { time: "18:00", title: "ğŸº å¤œã”é£¯", detail: "æµ·é®®å±…é…’å±‹ ã¾ã‚‹å®¶ è¥¿ä¸­æ´²", place: { name: "æµ·é®®å±…é…’å±‹ ã¾ã‚‹å®¶ è¥¿ä¸­æ´²" } },
      { time: "20:00", title: "ğŸ¸ 2ä»¶ç›®ï¼ˆæœªå®šï¼‰" },
      { time: "22:00", title: "ğŸ•’ è‡ªç”±æ™‚é–“" },
    ],
  },
  {
    day: "Day 3 (9/21 æ—¥)",
    events: [
      { time: "12:00", title: "ğŸ´ ãŠæ˜¼ï¼ˆå€™è£œï¼‰", detail: "å€™è£œã‹ã‚‰é¸æŠ", candidates: day2_3LunchCandidates },
      { time: "13:00", title: "ğŸ›ï¸ ç©ºæ¸¯ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ï¼ˆãŠåœŸç”£ï¼‰",
        candidates: [
          { name: "ANA FESTAï¼ˆå›½å†…ç·šï¼‰" },
          { name: "åšå¤šéŠ˜å“è”µ" },
          { name: "ãã‚‰ã‚‚ãƒ¼ã‚‹å•†åº—" },
          { name: "ç¦å¤ªéƒï¼ˆæ˜å¤ªå­ï¼‰" },
          { name: "æ±é›²å ‚ï¼ˆã«ã‚ã‹ã›ã‚“ãºã„ï¼‰" },
        ] },
      { time: "14:15", title: "ğŸ›¬ æ±äº¬çµ„ å¸°ã‚Šï¼ˆé£›è¡Œæ©Ÿï¼‰", detail: "14:15 â†’ 16:05", kind: "flight-in" },
      { time: "14:50", title: "ğŸ›¬ åå¤å±‹çµ„ å¸°ã‚Šï¼ˆé£›è¡Œæ©Ÿï¼‰", detail: "14:50 â†’ 16:40", kind: "flight-in" },
    ],
  },
];

/* ===== Flight details (compact) ===== */
const FLOOR_HND = "https://tokyo-haneda.com/floor/index.html";
const FLOOR_CENTRAIR = "https://www.centrair.jp/map/index.html";
const CHECKIN_GUIDE = "https://www.starflyer.jp/checkin/boarding/vender.html";

const FL_OUT = {
  title: "è¡Œãï¼ˆOUTBOUNDï¼‰",
  groups: [
    { label: "æ±äº¬çµ„ï¼ˆä¾¿åï¼šSFJ047ï¼‰", code: "SFJ047", book: "3101", conf: "482-743-569", pax: "ç”°ä¸­ã€æ–°äº•", counter: "ç¬¬1ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2éšSFJã‚«ã‚¦ãƒ³ã‚¿ãƒ¼" },
    { label: "åå¤å±‹çµ„1ï¼ˆä¾¿åï¼šSFJ063ï¼‰", code: "SFJ063", book: "3101", conf: "607-330-326", pax: "æµ…é‡ã€å®®è…°ã€ä¸Šå €", counter: "æ—…å®¢ã‚¿ãƒ¼ãƒŸãƒŠãƒ«3Få›½å†…ç·šANAã‚«ã‚¦ãƒ³ã‚¿ãƒ¼" },
    { label: "åå¤å±‹çµ„2ï¼ˆä¾¿åï¼šSFJ063ï¼‰", code: "SFJ063", book: "3104", conf: "197-714-403", pax: "é½Šè—¤ã€æ£®ã€é•·æ²¼ã€é‡ç”°ã€å‰ç”°", counter: "æ—…å®¢ã‚¿ãƒ¼ãƒŸãƒŠãƒ«3Få›½å†…ç·šANAã‚«ã‚¦ãƒ³ã‚¿ãƒ¼" },
  ],
};

const FL_IN = {
  title: "å¸°ã‚Šï¼ˆINBOUNDï¼‰",
  groups: [
    { label: "æ±äº¬çµ„ï¼ˆä¾¿åï¼šSFJ048ï¼‰", code: "SFJ048", book: "3109", conf: "763-117-264", pax: "æ–°äº•ã€ç”°ä¸­", counter: "ç¬¬1ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2éšSFJã‚«ã‚¦ãƒ³ã‚¿ãƒ¼" },
    { label: "åå¤å±‹çµ„1ï¼ˆä¾¿åï¼šSFJ062ï¼‰", code: "SFJ062", book: "3102", conf: "482-743-329", pax: "æµ…é‡ã€å®®è…°ã€ä¸Šå €", counter: "æ—…å®¢ã‚¿ãƒ¼ãƒŸãƒŠãƒ«3Få›½å†…ç·šANAã‚«ã‚¦ãƒ³ã‚¿ãƒ¼" },
    { label: "åå¤å±‹çµ„2ï¼ˆä¾¿åï¼šSFJ062ï¼‰", code: "SFJ062", book: "3105", conf: "825-237-635", pax: "é½Šè—¤ã€æ£®ã€é•·æ²¼ã€é‡ç”°ã€å‰ç”°", counter: "æ—…å®¢ã‚¿ãƒ¼ãƒŸãƒŠãƒ«3Få›½å†…ç·šANAã‚«ã‚¦ãƒ³ã‚¿ãƒ¼" },
  ],
};

/* ===== UI bits ===== */
const Pill = ({ children, onClick, variant = "light" }) => (
  <button
    onClick={onClick}
    className={
      variant === "solid"
        ? "inline-flex items-center gap-1 px-4 py-2 rounded-full bg-gray-900 text-white text-sm"
        : "inline-flex items-center gap-1 px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm"
    }
  >
    {children}
  </button>
);

/* ===== Map Dialog ===== */
function MapDialog({ open, place, onClose }) {
  useEffect(() => { document.body.style.overflow = open ? "hidden" : ""; }, [open]);
  if (!open || !place) return null;
  return (
    <div className="fixed inset-0 z-[1000]" onClick={onClose}>
      <div className="absolute inset-0 bg-black/50"></div>
      <div className="absolute inset-x-4 sm:left-1/2 sm:-translate-x-1/2 top-[15%] max-w-md rounded-2xl bg-white shadow-xl p-5" onClick={(e)=>e.stopPropagation()}>
        <div className="text-xs text-gray-500">åœ°å›³ã‚’é–‹ã</div>
        <h3 className="text-lg font-semibold mt-1 break-words">{place.name ?? place.label}</h3>
        <div className="mt-3 grid grid-cols-2 gap-2">
          <Pill variant="solid" onClick={() => { window.open(mapLink("google", place), "_blank"); onClose(); }}>Google Maps</Pill>
          <Pill variant="solid" onClick={() => { window.open(mapLink("apple", place), "_blank"); onClose(); }}>Apple Maps</Pill>
        </div>
        <div className="mt-4 flex justify-end">
          <Pill onClick={onClose}>é–‰ã˜ã‚‹</Pill>
        </div>
      </div>
    </div>
  );
}

/* ===== Flight Drawer (swipe to close ~4cm) ===== */
const SWIPE_CLOSE_PX = 150; // ç´„4cmç›¸å½“

function FlightDrawer({ open, mode, onClose }) {
  const data = mode === "out" ? FL_OUT : FL_IN;
  const [expanded, setExpanded] = useState({});
  const startY = useRef(0);
  const travel = useRef(0);
  const panelRef = useRef(null);
  const dragging = useRef(false);

  useEffect(() => { document.body.style.overflow = open ? "hidden" : ""; }, [open]);
  useEffect(() => { if (open) setExpanded({}); }, [open, mode]);

  if (!open) return null;

  const begin = (y) => {
    dragging.current = true;
    startY.current = y;
    travel.current = 0;
    if (panelRef.current) panelRef.current.style.transition = "none";
  };
  const move = (y) => {
    if (!dragging.current) return;
    travel.current = Math.max(0, y - startY.current);
    if (panelRef.current) panelRef.current.style.transform = `translateY(${travel.current}px)`;
  };
  const end = () => {
    if (!dragging.current) return;
    dragging.current = false;
    const d = travel.current;
    if (panelRef.current) panelRef.current.style.transition = "transform 220ms ease";
    if (d > SWIPE_CLOSE_PX) {
      if (typeof onClose === 'function') onClose();
    } else {
      if (panelRef.current) panelRef.current.style.transform = "translateY(0)";
      setTimeout(() => { if (panelRef.current) panelRef.current.style.transition = ""; }, 240);
    }
    travel.current = 0;
  };

  useEffect(() => {
    const p = panelRef.current;
    if (!p) return;
    const onMS = (e) => begin(e.clientY);
    const onMM = (e) => move(e.clientY);
    const onMU = () => end();

    const onTS = (e) => begin(e.touches[0].clientY);
    const onTM = (e) => move(e.touches[0].clientY);
    const onTE = () => end();

    p.addEventListener("mousedown", onMS);
    window.addEventListener("mousemove", onMM);
    window.addEventListener("mouseup", onMU);
    p.addEventListener("touchstart", onTS, { passive: true });
    p.addEventListener("touchmove", onTM, { passive: true });
    p.addEventListener("touchend", onTE);

    return () => {
      p.removeEventListener("mousedown", onMS);
      window.removeEventListener("mousemove", onMM);
      window.removeEventListener("mouseup", onMU);
      p.removeEventListener("touchstart", onTS);
      p.removeEventListener("touchmove", onTM);
      p.removeEventListener("touchend", onTE);
    };
  }, [open]);

  return () => {
      p.removeEventListener("mousedown", onMS);
      window.removeEventListener("mousemove", onMM);
      window.removeEventListener("mouseup", onMU);
      p.removeEventListener("touchstart", onTS);
      p.removeEventListener("touchmove", onTM);
      p.removeEventListener("touchend", onTE);
    };
  }, [open]);

  return (
    <div className="fixed inset-0 z-[1000]" onClick={onClose}>
      <div className="absolute inset-0 bg-black/50"></div>
      <div
        ref={panelRef}
        className="absolute inset-x-0 bottom-0 max-h-[82vh] bg-white rounded-t-3xl shadow-2xl p-5 overflow-auto"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="mx-auto mb-3 h-1.5 w-10 rounded-full bg-gray-300" />
        <div className="flex items-center justify-between">
          <h3 className="text-xl font-bold">{data.title}</h3>
        </div>
        <div className="mt-3 grid grid-cols-2 gap-3">
          <a className="block rounded-xl border border-gray-200 px-3 py-2 text-center hover:bg-gray-50" href={FLOOR_HND} target="_blank" rel="noreferrer">ç¾½ç”°ãƒ•ãƒ­ã‚¢ãƒãƒƒãƒ—</a>
          <a className="block rounded-xl border border-gray-200 px-3 py-2 text-center hover:bg-gray-50" href={FLOOR_CENTRAIR} target="_blank" rel="noreferrer">ã‚»ãƒ³ãƒˆãƒ¬ã‚¢ãƒ•ãƒ­ã‚¢ãƒãƒƒãƒ—</a>
          <a className="col-span-2 block rounded-xl bg-gray-900 text-white px-3 py-2 text-center" href={CHECKIN_GUIDE} target="_blank" rel="noreferrer">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ–¹æ³•</a>
        </div>
        <p className="mt-3 text-[13px] text-gray-600">â€» é›†åˆã¯å‡ºç™ºã®<strong className="font-semibold">60åˆ†å‰</strong>ã€‚äºˆç´„ç•ªå·ãƒ»ç¢ºèªç•ªå·ã‚’æº–å‚™ã—ã¦ãŠãã€‚</p>

        <div className="mt-4 space-y-3">
          {(mode === "out" ? FL_OUT.groups : FL_IN.groups).map((g, idx) => (
            <details key={idx} className="rounded-2xl border border-gray-200 overflow-hidden">
              <summary className="cursor-pointer px-4 py-3 font-semibold select-none">{g.label}</summary>
              <div className="px-4 pb-4 pt-1 text-[15px] leading-7 grid grid-cols-[120px_1fr] gap-x-3">
                <div className="text-gray-500">äºˆç´„ç•ªå·</div><div>{g.book}</div>
                <div className="text-gray-500">ç¢ºèªç•ªå·</div><div>{g.conf}</div>
                <div className="text-gray-500">æ­ä¹—è€…</div><div>{g.pax}</div>
                <div className="text-gray-500">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å ´æ‰€</div><div>{g.counter}</div>
              </div>
            </details>
          ))}
        </div>

        <div className="mt-5 flex justify-center">
          <button className="rounded-full bg-gray-900 text-white px-5 py-2" onClick={onClose}>é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  );
}

/* ===== Timeline row ===== */
const TIME_COL = 72; // px
const RAIL_COL = 20; // px
const GRID_GAP = 16; // px
const RAIL_OFFSET = -1; // tweak if blue dot not centered
const RAIL_LEFT_PX = TIME_COL + GRID_GAP + RAIL_COL / 2 + RAIL_OFFSET;

function EventRow({ ev, openMap, openFlight }) {
  return (
    <div className="grid items-center mb-8" style={{ gridTemplateColumns: `${TIME_COL}px ${RAIL_COL}px 1fr`, columnGap: `${GRID_GAP}px` }}>
      <div className="text-right font-bold text-gray-800 tabular-nums">{ev.time}</div>
      <div className="relative flex items-center justify-center">
        <div className="w-3 h-3 bg-blue-600 rounded-full" />
      </div>
      <div className="bg-white rounded-2xl shadow p-4">
        <div className="font-semibold text-gray-900 text-lg">{ev.title}</div>
        {ev.detail && <div className="text-sm text-gray-600 mt-1">{ev.detail}</div>}
        {ev.place && (
          <div className="mt-3"><Pill onClick={() => openMap(ev.place)}>åœ°å›³ã‚’é–‹ã</Pill></div>
        )}
        {ev.candidates && (
          <div className="mt-3">
            <div className="text-xs text-gray-500 mb-2">å€™è£œï¼ˆã‚¿ãƒƒãƒ—ã§ãƒãƒƒãƒ—ã‚’é¸æŠï¼‰</div>
            <div className="flex flex-wrap gap-2">
              {ev.candidates.map((c, i) => (
                <Pill key={i} onClick={() => openMap({ name: c.name })}>{c.name}</Pill>
              ))}
            </div>
          </div>
        )}
        {(ev.kind || ev.action) && (
          <div className="mt-3"><Pill onClick={() => (()=>{ const k = ev.kind || ev.action; const m = (k === "flight-out" || k === "outbound" || k === "out") ? "out" : "in"; openFlight(m); })()}>ä¾¿ã®è©³ç´°</Pill></div>
        )}
      </div>
    </div>
  );
}

function DaySection({ day, events, openMap, openFlight }) {
  return (
    <div className="mb-12">
      <h2 className="text-xl font-semibold mb-6 border-b pb-2">{day}</h2>
      <div className="relative">
        <div className="absolute bg-gray-300" style={{ left: `${RAIL_LEFT_PX}px`, top: 10, bottom: 10, width: 2, borderRadius: 9999 }} />
        <div>
          {events.map((ev, i) => (
            <EventRow key={i} ev={ev} openMap={openMap} openFlight={openFlight} />
          ))}
        </div>
      </div>
    </div>
  );
}

export default function App() {
  const [mapOpen, setMapOpen] = useState(false);
  const [mapPlace, setMapPlace] = useState(null);
  const [flightOpen, setFlightOpen] = useState(false);
  const [flightMode, setFlightMode] = useState("out");

  const openMap = (place) => { setMapPlace(place); setMapOpen(true); };
  const openFlight = (mode) => { setFlightMode(mode); setFlightOpen(true); };

  return (
    <div className="min-h-screen w-full flex flex-col items-center bg-gray-100 text-gray-900" style={{ paddingTop: 'calc(env(safe-area-inset-top, 0px) + 16px)' }}>
      <header className="w-full max-w-4xl px-6 md:px-8">
        <h1 className="text-3xl font-extrabold tracking-wide mt-2">ç¦å²¡æ—…è¡Œ</h1>
        <p className="text-sm text-gray-600 mb-6">æœŸé–“ï¼š2025.09.19 - 2025.09.21</p>
      </header>

      <main className="w-full max-w-4xl px-6 md:px-8">
        {timeline.map((d, idx) => (
          <DaySection key={idx} {...d} openMap={openMap} openFlight={openFlight} />
        ))}
      </main>

      <footer className="mt-2 text-xs text-gray-500 text-center pb-10 px-6">
        ğŸ“Œ iPhoneã§ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ï¼šSafariã§é–‹ã â†’ å…±æœ‰ï¼ˆâ–¡ã«â†‘ï¼‰â†’ <b>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </b>
      </footer>

      {/* dialogs */}
      <MapDialog open={mapOpen} place={mapPlace} onClose={() => setMapOpen(false)} />
      <FlightDrawer open={flightOpen} mode={flightMode} onClose={() => setFlightOpen(false)} />
    </div>
  );
}
